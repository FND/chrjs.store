/*
 * A store object, using the chrjs library.
 *
 * mechanisms to interact with tiddlers, bags, recipes, etc on TiddlySpace
 * and mechanisms to refresh those things and keep them up to date in the
 * browser.
 *
 * Dependencies: chrjs, jQuery
 *
 * Written by Ben Gillies
 *//*global tiddlyweb, window, jQuery*/(function(a){var b;b=function(c,d){var e=[];e.store=c,d&&a.each(d,function(a,b){e.push(b)});var f=function(a,b){return a&&a.indexOf(b)!==-1?!0:!1};a.extend(e,{tag:function(a){return e.map(function(b){return f(b.tags,a)?b:null})},text:function(a){return e.map(function(b){return f(b.text,a)?b:null})},title:function(a){return e.map(function(b){return f(b.title,a)?b:null})},attr:function(a,b){var c=b?!1:!0,d=function(b){return b[a]||b.fields&&b.fields[a]};return e.map(function(a){return c?d(a)?a:null:f(d(a),b)?a:null})},not:function(a,b){var c=b?!1:!0,d=function(b){return b[a]||b.fields&&b.fields[a]};return e.map(function(a){return c?d(a)?null:a:f(d(a),b)?null:a})},bag:function(a){return e.map(function(b){var c=b.bag&&b.bag.name;return c===a?b:null})},space:function(a){var b=/(_public|_private|_archive)$/;return e.map(function(c){var d=c.bag&&c.bag.name;return d.replace(b,"")===a?c:null})},recipe:function(a){var b=a===undefined?!0:!1,c;b&&(c=e.store.recipe.name);return e.map(function(d){b||(c=d.recipe&&d.recipe.name);return c===a?d:null})},dirty:function(a){return a?e.map(function(b){return b.lastSync?+b.lastSync<+a?b:null:b}):e.map(function(a){return a.lastSync?null:a})},each:function(b){a.each(e,function(a,c){b.apply(e,[c,a])});return e},map:function(c){var d=b(e.store);a.each(e,function(a,b){var f=c.apply(e,[b,a]);f&&d.push(f)});return d},reduce:function(b,c){var d=b;a.each(e,function(a,b){d=c.apply(e,[b,d])});return d},bind:function(a){var b=function(b){a.apply(e,[b])};e.each(function(a){e.store.bind("tiddler",a.title,b)});return e},save:function(b){a.each(e,function(a,c){e.store.save(c,b)});return e},add:function(b){b instanceof tiddlyweb.Tiddler?(e.push(b),e.store.add(b)):a.each(b,function(a,c){e.push(c),e.store.add(b)});return e}});return e},tiddlyweb.Store=function(c,d){d===undefined&&(d=!0);var e,f={name:"",type:"private"},g={recipe:{all:[]},bag:{all:[]},tiddler:{all:[]}},h=function(a){return encodeURIComponent(a.bag.name)+"/"+encodeURIComponent(a.title)},i=function(a,b){var c;a instanceof tiddlyweb.Bag?c={thing:a,tiddlers:{}}:(a.lastSync=b?null:new Date,c=a);return c},j={},k=function(c,d){var f,g=b(e,d),h=[];g=g.map(function(a){return a.title}),c instanceof tiddlyweb.Bag?(f=j[c.name].tiddlers,a.each(f,function(a,b){g.indexOf(b.title)===-1&&h.push([c.name,a])})):c instanceof tiddlyweb.Recipe&&e.each(function(a,b){a.recipe&&a.recipe.name===c.name&&g.indexOf(a.title)===-1&&h.push([a.bag.name,b])}),a.each(h,function(a,b){var c=b[1],d=b[0],f=j[d].tiddlers[c];delete j[d].tiddlers[c],e.trigger("tiddler",null,[f,"deleted"]),e.trigger("tiddler",c,[f,"deleted"])})},l;l=function(a){if(a instanceof tiddlyweb.Bag){j[a.name]?j[a.name].thing=a:j[a.name]=i(a),e.trigger("bag",null,a),e.trigger("bag",a.name,a);return!0}var b=a.bag.name,c=j[b]?j[b]:!l(new tiddlyweb.Bag(b,"/")),d=!c||!c.tiddlers[a.title]?null:c.tiddlers[a.title].revision;j[b].tiddlers[a.title]=i(a),a.revision!==d&&(e.trigger("tiddler",null,a),e.trigger("tiddler",a.title,a));return!0},e=function(a,c){var d=b(e);e.each(function(a,b){d.push(a)}),d[a]?d=d[a](c):a&&(d=d.attr(a,c));return d},e.recipe=null,e.pending={},e.getSpace=function(b){f.name!==""?b(f):a.ajax({url:"/?limit=1",dataType:"json",success:function(a){var c=(a instanceof Array?a[0].recipe:a.recipe)||"No Recipe Found",d=c.match(/^(.*)_(private|public)$/);d?(f.name=d[1],f.type=d[2],e.recipe=new tiddlyweb.Recipe(c,"/"),b(f)):b(null,{name:"NoSpaceMatchError",message:a.recipe+" is not a valid space"})},error:function(a,c,d){b(null,d)}});return e},e.bind=function(a,b,c){g[a]&&(b?(g[a][b+a]||(g[a][b+a]=[]),g[a][b+a].push(c)):g[a].all.push(c));return e},e.unbind=function(b,c,d){var f=function(b){if(d){a.each(b,function(a,c){d===c&&b.splice(a,1)});return b}return[]};g[b]&&c?g[b][c+b]=f(g[b][c+b]):g[b].all=f(g[b].all);return e},e.trigger=function(b,c,d){var f=d instanceof Array?d:[d];g[b]&&(a.each(g[b].all,function(a,b){b.apply(e,f)}),c&&g[b][c+b]&&a.each(g[b][c+b],function(a,b){b.apply(e,f)}));return e},e.refresh=function(b){var c=function(c){var d=c.tiddlers();d.get(function(d){a.each(d,function(a,b){l(b)}),k(c,d),b&&b.apply(e,[d])},function(a,b,c){throw{name:"RetrieveTiddlersError",message:"Error getting tiddlers: "+c}})};e.recipe?c(e.recipe):e.getSpace(function(){e.recipe&&c(e.recipe)});return e},e.get=function(a,b,c){var d=e.pending[a]||null,f=function(){var b=d;if(a instanceof tiddlyweb.Tiddler)return a;if(b)return b;e.each(function(c,d){if(d===a){b=c;return!1}});return b}(),g=typeof b=="function"?!1:!0;if(g)return f;d?b(d):f?f.get(function(a){l(a),b(a)},function(a,c,d){b(null,{name:"RetrieveTiddlersError",message:"Error getting tiddler: "+d})},c?"render=1":""):b(null);return e},e.each=function(a,b){var c=typeof a=="function"?a:b,d=a==="bag"?!1:!0,f=function(a,b){var c=!0,d;for(d in a)if(a.hasOwnProperty(d)&&b(a[d],d)===!1){c=!1;break}return c};if(d&&!f(e.pending,c))return e;f(j,function(a,b){if(d){if(!f(j[b].tiddlers,c))return!1}else if(c(a.thing,b)===!1)return!1});return e},e.add=function(a){var b=function(a){var b;window.hasOwnProperty("localStorage")&&(b=h(a),window.localStorage.setItem(b,a.toJSON()))};e.pending[a.title]=i(a,!0),a.bag?(b(a),e.trigger("tiddler",null,a),e.trigger("tiddler",a.title,a)):e.getSpace(function(c){var d=c.name+"_public";a.bag=j[d]&&j[d].thing||new tiddlyweb.Bag(d,"/"),b(a),e.trigger("tiddler",null,a),e.trigger("tiddler",a.title,a)});return e},e.save=function(b,c){var d=!0,f=b instanceof tiddlyweb.Tiddler,g=!f&&b?b:c,j=function(a,b){delete e.pending[a.title],a.put(function(c){window.hasOwnProperty("localStorage")&&window.localStorage.removeItem(h(a)),c=i(c),l(c),b(c)},function(c,d,f){e.pending[a.title]||(e.pending[a.title]=i(a,!0)),b(null,{name:"SaveError",message:"Error saving "+a.title+": "+f})})};if(f){j(b,g);return e}a.each(e.pending,function(a,b){d&&(d=!1),j(b,g)}),d&&g(null,{name:"EmptyError",message:"Nothing to save"});return e},e.remove=function(a,b){var c=a instanceof tiddlyweb.Tiddler,d=typeof a=="string"?e.get(a):c?a:a.tiddler||null,f=b||a.callback||null,g=!c&&a["delete"]||!1,h=!c&&a.pending!==undefined?a.pending:!0,i=function(a,b,c){var d=a.bag.name;b&&delete e.pending[a.title],c&&(d=a.bag.name,delete j[d].tiddlers[a.title]),f&&f(a)};if(!d)return e;g?d["delete"](function(){i(d,!0,!0)},function(a,b,c){f&&f(null,{name:"DeleteError",message:"Error deleting "+d.title+": "+c})}):h?i(d,!0,!1):i(d,!1,!0);return e},e.retrieveCached=function(){window.hasOwnProperty("localStorage")&&a.each(window.localStorage,function(b){var c=window.localStorage.key(b),d=c.split("/"),f=decodeURIComponent(d[0]),g=decodeURIComponent(d[1]),h=a.parseJSON(window.localStorage[c]),i=new tiddlyweb.Tiddler(g);i.bag=new tiddlyweb.Bag(f,"/"),a.extend(i,h),e.add(i,!0)});return e},d&&e.retrieveCached(),c&&e.refresh(c);return e}})(jQuery)