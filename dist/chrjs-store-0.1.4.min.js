/*
 * A store object, using the chrjs library.
 *
 * mechanisms to interact with tiddlers, bags, recipes, etc on TiddlySpace
 * and mechanisms to refresh those things and keep them up to date in the
 * browser.
 *
 * Dependencies: chrjs, jQuery
 *
 * Written by Ben Gillies
 *//*global tiddlyweb, window, jQuery*/(function(a){var b;try{b="localStorage"in window&&window.localStorage!==null}catch(c){b=!1}var d;d=function(b,c){var e=[];e.store=b,c&&a.each(c,function(a,b){e.push(b)});var f=function(a,b){return a&&a.indexOf(b)!==-1?!0:!1};a.extend(e,{tag:function(a){return e.map(function(b){return f(b.tags,a)?b:null})},text:function(a){return e.map(function(b){return f(b.text,a)?b:null})},title:function(a){return e.map(function(b){return f(b.title,a)?b:null})},attr:function(a,b){var c=b?!1:!0,d=function(b){return b[a]||b.fields&&b.fields[a]};return e.map(function(a){return c?d(a)?a:null:f(d(a),b)?a:null})},not:function(a,b){var c=b?!1:!0,d=function(b){return b[a]||b.fields&&b.fields[a]};return e.map(function(a){return c?d(a)?null:a:f(d(a),b)?null:a})},bag:function(a){return e.map(function(b){var c=b.bag&&b.bag.name;return c===a?b:null})},space:function(a){var b=/(_public|_private|_archive)$/;return e.map(function(c){var d=c.bag&&c.bag.name;return d.replace(b,"")===a?c:null})},recipe:function(a){var b=a===undefined?!0:!1,c;b&&(c=e.store.recipe.name);return e.map(function(d){b||(c=d.recipe&&d.recipe.name);return c===a?d:null})},dirty:function(a){return a?e.map(function(b){return b.lastSync?+b.lastSync<+a?b:null:b}):e.map(function(a){return a.lastSync?null:a})},each:function(b){a.each(e,function(a,c){b.apply(e,[c,a])});return e},map:function(b){var c=d(e.store);a.each(e,function(a,d){var f=b.apply(e,[d,a]);f&&c.push(f)});return c},reduce:function(b,c){var d=b;a.each(e,function(a,b){d=c.apply(e,[b,d])});return d},bind:function(a){var b=function(b){a.apply(e,[b])};e.each(function(a){e.store.bind("tiddler",a.title,b)});return e},save:function(b){a.each(e,function(a,c){e.store.save(c,b)});return e},add:function(b){b instanceof tiddlyweb.Tiddler?(e.push(b),e.store.add(b)):a.each(b,function(a,c){e.push(c),e.store.add(b)});return e}});return e},tiddlyweb.Store=function(c,e){e===undefined&&(e=!0);var f,g={name:"",type:"private"},h={recipe:{all:[]},bag:{all:[]},tiddler:{all:[]}},i=function(a){return encodeURIComponent(a.bag.name)+"/"+encodeURIComponent(a.title)},j=function(a,b){var c;a instanceof tiddlyweb.Bag?c={thing:a,tiddlers:{}}:(a.lastSync=b?null:new Date,c=a);return c},k={},l=function(b,c){var e,g=d(f,c),h=[];g=g.map(function(a){return a.title}),b instanceof tiddlyweb.Bag?(e=k[b.name].tiddlers,a.each(e,function(a,c){g.indexOf(c.title)===-1&&h.push([b.name,a])})):b instanceof tiddlyweb.Recipe&&f.each(function(a,c){a.recipe&&a.recipe.name===b.name&&g.indexOf(a.title)===-1&&h.push([a.bag.name,c])}),a.each(h,function(a,b){var c=b[1],d=b[0],e=k[d].tiddlers[c];delete k[d].tiddlers[c],f.trigger("tiddler",null,[e,"deleted"]),f.trigger("tiddler",c,[e,"deleted"])})},m;m=function(a){if(a instanceof tiddlyweb.Bag){k[a.name]?k[a.name].thing=a:k[a.name]=j(a),f.trigger("bag",null,a),f.trigger("bag",a.name,a);return!0}var b=a.bag.name,c=k[b]?k[b]:!m(new tiddlyweb.Bag(b,"/")),d=!c||!c.tiddlers[a.title]?null:c.tiddlers[a.title].revision;k[b].tiddlers[a.title]=j(a),a.revision!==d&&(f.trigger("tiddler",null,a),f.trigger("tiddler",a.title,a));return!0},f=function(b,c){var e=d(f);f.each(function(a,b){e.push(a)}),e[b]?e=e[b](c):b&&(e=e.attr(b,c)),e=e.map(function(b){return a.extend(!0,{},b)});return e},f.recipe=null,f.pending={},f.getSpace=function(b){g.name!==""?b(g):a.ajax({url:"/?limit=1",dataType:"json",success:function(a){var c=(a instanceof Array?a[0].recipe:a.recipe)||"No Recipe Found",d=c.match(/^(.*)_(private|public)$/);d?(g.name=d[1],g.type=d[2],f.recipe=new tiddlyweb.Recipe(c,"/"),b(g)):b(null,{name:"NoSpaceMatchError",message:a.recipe+" is not a valid space"})},error:function(a,c,d){b(null,d,a)}});return f},f.bind=function(a,b,c){h[a]&&(b?(h[a][b+a]||(h[a][b+a]=[]),h[a][b+a].push(c)):h[a].all.push(c));return f},f.unbind=function(b,c,d){var e=function(b){if(d){a.each(b,function(a,c){d===c&&b.splice(a,1)});return b}return[]};h[b]&&c?h[b][c+b]=e(h[b][c+b]):h[b].all=e(h[b].all);return f},f.trigger=function(b,c,d){var e=d instanceof Array?d:[d];h[b]&&(a.each(h[b].all,function(a,b){b.apply(f,e)}),c&&h[b][c+b]&&a.each(h[b][c+b],function(a,b){b.apply(f,e)}));return f},f.refresh=function(b){var c=function(c){var d=c.tiddlers();d.get(function(d){a.each(d,function(a,b){m(b)}),l(c,d),b&&b.apply(f,[d])},function(a,c,d){b(null,{name:"RetrieveTiddlersError",message:"Error getting tiddlers: "+d},a)})};f.recipe?c(f.recipe):f.getSpace(function(){f.recipe&&c(f.recipe)});return f},f.get=function(b,c,d,e){var g=f.pending[b]||f.pending[b.title]||null,h=function(){var a=!e&&g?g:b;if(a instanceof tiddlyweb.Tiddler)return a;f.each(function(b,c){if(c===a){a=b;return!1}});return a}();if(!c)return a.extend(!0,{},h);!e&&g?c.call(f,a.extend(!0,{},h)):h?h.get(function(b){m(b),c.call(f,a.extend(!0,{},b))},function(a,b,d){c.call(f,null,{name:"RetrieveTiddlersError",message:"Error getting tiddler: "+d},a)},d?"render=1":""):c.call(null,{name:"NotFoundError",message:"Tiddler not found"});return f},f.each=function(a,b){var c=typeof a=="function"?a:b,d=a==="bag"?!1:!0,e=function(a,b){var c=!0,d;for(d in a)if(a.hasOwnProperty(d)&&b(a[d],d)===!1){c=!1;break}return c};if(d&&!e(f.pending,c))return f;e(k,function(a,b){if(d){if(!e(k[b].tiddlers,c))return!1}else if(c(a.thing,b)===!1)return!1});return f},f.add=function(a){var c=function(a){var c;b&&(c=i(a),window.localStorage.setItem(c,a.toJSON()))};f.pending[a.title]=j(a,!0),a.bag?(c(a),f.trigger("tiddler",null,a),f.trigger("tiddler",a.title,a)):f.getSpace(function(b){var d=b.name+"_public";a.bag=k[d]&&k[d].thing||new tiddlyweb.Bag(d,"/"),c(a),f.trigger("tiddler",null,a),f.trigger("tiddler",a.title,a)});return f},f.save=function(c,d){var e=!0,g=c instanceof tiddlyweb.Tiddler,h=!g&&c?c:d,k=function(a,c){delete f.pending[a.title],a.put(function(d){b&&window.localStorage.removeItem(i(a)),d=j(d),m(d),c(d)},function(b,d,e){f.pending[a.title]||(f.pending[a.title]=j(a,!0)),c(null,{name:"SaveError",message:"Error saving "+a.title+": "+e},b)})};if(g){k(c,h);return f}a.each(f.pending,function(a,b){e&&(e=!1),k(b,h)}),e&&h(null,{name:"EmptyError",message:"Nothing to save"});return f},f.remove=function(c,d){var e={pending:!0,server:!1,tiddler:c,callback:d||function(){}};typeof c=="string"?e.tiddler=f.get(c):c instanceof tiddlyweb.Tiddler||a.extend(e,c);if(!e.tiddler)return f;e.pending&&(delete f.pending[e.tiddler.title],b&&window.localStorage.removeItem(i(e.tiddler))),e.server?e.tiddler["delete"](function(a){k[a.bag.name]&&delete k[a.bag.name].tiddlers[a.title],e.callback(a)},function(a,b,c){e.callback(null,{name:"DeleteError",message:"Error deleting "+e.tiddler.title+": "+c},a)}):e.callback(e.tiddler);return f},f.retrieveCached=function(){b&&a.each(window.localStorage,function(b){var c=window.localStorage.key(b),d=c.split("/"),e=decodeURIComponent(d[0]),g=decodeURIComponent(d[1]),h=a.parseJSON(window.localStorage[c]),i=new tiddlyweb.Tiddler(g);i.bag=new tiddlyweb.Bag(e,"/"),a.extend(i,h),f.add(i,!0)});return f},e&&f.retrieveCached(),c&&f.refresh(c);return f}})(jQuery)