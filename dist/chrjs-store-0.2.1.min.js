/* Chrjs-Store
 * A modular store for TiddlySpace
 *
 * See https://github.com/bengillies/chrjs.store for more
 *
 * Dependencies: chrjs library, jQuery, TiddlySpace, RequireJS
 *
 * Version: 0.2.1
 *
 * created by Ben Gillies
 * Chrjs-Store is distributed under a BSD License
 */define("filter",["require","exports","module"],function(){var a;a=function(b,c){var d=[];d.store=b,c&&$.each(c,function(a,b){d.push(b)});var e=function(a,b){return a&&a.indexOf(b)!==-1?!0:!1};$.extend(d,{tag:function(a){return d.map(function(b){return e(b.tags,a)?b:null})},text:function(a){return d.map(function(b){return e(b.text,a)?b:null})},title:function(a){return d.map(function(b){return e(b.title,a)?b:null})},attr:function(a,b){var c=b?!1:!0,f=function(b){return b[a]||b.fields&&b.fields[a]};return d.map(function(a){return c?f(a)?a:null:e(f(a),b)?a:null})},not:function(a,b){var c=b?!1:!0,f=function(b){return b[a]||b.fields&&b.fields[a]};return d.map(function(a){return c?f(a)?null:a:e(f(a),b)?null:a})},bag:function(a){return d.map(function(b){var c=b.bag&&b.bag.name;return c===a?b:null})},space:function(a){var b=/(_public|_private|_archive)$/;return d.map(function(c){var d=c.bag&&c.bag.name;return d.replace(b,"")===a?c:null})},recipe:function(a){var b=a===undefined?!0:!1,c;b&&(c=d.store.recipe.name);return d.map(function(d){b||(c=d.recipe&&d.recipe.name);return c===a?d:null})},dirty:function(a){return a?d.map(function(b){return b.lastSync?+b.lastSync<+a?b:null:b}):d.map(function(a){return a.lastSync?null:a})},each:function(a){$.each(d,function(b,c){a.apply(d,[c,b])});return d},map:function(b){var c=a(d.store);$.each(d,function(a,e){var f=b.apply(d,[e,a]);f&&c.push(f)});return c},reduce:function(a,b){var c=a;$.each(d,function(a,e){c=b.apply(d,[e,c])});return c},bind:function(a){var b=function(b){a.apply(d,[b])};d.each(function(a){d.store.bind("tiddler",a.title,b)});return d},save:function(a){$.each(d,function(b,c){d.store.save(c,a)});return d},add:function(a){a instanceof tiddlyweb.Tiddler?(d.push(a),d.store.add(a)):$.each(a,function(b,c){d.push(c),d.store.add(a)});return d}});return d};return a}),define("event",["require","exports","module"],function(){return function(){var a={recipe:{all:[]},bag:{all:[]},tiddler:{all:[]}},b={bind:function(b,c,d){a[b]&&(c?(a[b][c+b]||(a[b][c+b]=[]),a[b][c+b].push(d)):a[b].all.push(d))},unbind:function(b,c,d){var e=function(a){if(d){$.each(a,function(b,c){d===c&&a.splice(b,1)});return a}return[]};a[b]&&c?a[b][c+b]=e(a[b][c+b]):a[b].all=e(a[b].all)},trigger:function(b,c,d){var e=$.isArray(d)?d:[d];a[b]&&($.each(a[b].all,function(a,b){b.apply(self,e)}),c&&a[b][c+b]&&$.each(a[b][c+b],function(a,b){b.apply(self,e)}))}};return b}}),define("cache",["require","exports","module"],function(){var a=function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return!1}}(),b=function(a){return encodeURIComponent(a.bag.name)+"/"+encodeURIComponent(a.title)};return{isCaching:a,set:function(c){var d=b(c);a&&window.localStorage.setItem(d,c.toJSON())},get:function(c){var d=b(c),e,f;if(a){e=window.localStorage[d],f=$.parseJSON(e),e=new tiddlyweb.Tiddler(c.title),e.bag=c.bag,$.extend(e,f);return e}return null},remove:function(c){var d=b(c);a&&window.localStorage.removeItem(d)},list:function(){var b=[];a&&$.each(window.localStorage,function(a){try{var c=window.localStorage.key(a),d,e,f,g,h;d=c.split("/");if(d.length!==2)throw"BadKey";e=decodeURIComponent(d[0]),f=decodeURIComponent(d[1]),g=$.parseJSON(window.localStorage[c]),h=new tiddlyweb.Tiddler(f),h.bag=new tiddlyweb.Bag(e,"/"),$.extend(h,g),b.push(h)}catch(i){}});return b},clear:function(){a&&window.localStorage.clear()}}}),define("store",["filter","event","cache"],function(a,b,c){return function(d,e){e===undefined&&(e=!0);var f,g={name:"",type:"private"},h=b(),i=function(a,b){var c;a instanceof tiddlyweb.Bag?c={thing:a,tiddlers:{}}:(a.lastSync=b?null:new Date,c=a);return c},j={},k=function(b,c){var d,e=a(f,c),g=[];e=e.map(function(a){return a.title}),b instanceof tiddlyweb.Bag?(d=j[b.name].tiddlers,$.each(d,function(a,c){e.indexOf(c.title)===-1&&g.push([b.name,a])})):b instanceof tiddlyweb.Recipe&&f.each(function(a,c){a.recipe&&a.recipe.name===b.name&&e.indexOf(a.title)===-1&&g.push([a.bag.name,c])}),$.each(g,function(a,b){var c=b[1],d=b[0],e=j[d].tiddlers[c];delete j[d].tiddlers[c],f.trigger("tiddler",c,[e,"deleted"])})},l;l=function(a){if(a instanceof tiddlyweb.Bag){j[a.name]?j[a.name].thing=a:j[a.name]=i(a),f.trigger("bag",a.name,a);return!0}var b=a.bag.name,c=j[b]?j[b]:!l(new tiddlyweb.Bag(b,"/")),d=!c||!c.tiddlers[a.title]?null:c.tiddlers[a.title].revision;j[b].tiddlers[a.title]=i(a),a.revision!==d&&f.trigger("tiddler",a.title,a);return!0},f=function(b,c){var d=a(f);f.each(function(a,b){d.push(a)}),d[b]?d=d[b](c):b&&(d=d.attr(b,c)),d=d.map(function(a){return $.extend(!0,new tiddlyweb.Tiddler,a)});return d},f.recipe=null,f.pending={},f.getSpace=function(a){g.name!==""?a(g):$.ajax({url:"/?limit=1",dataType:"json",success:function(b){var c=(b instanceof Array?b[0].recipe:b.recipe)||"No Recipe Found",d=c.match(/^(.*)_(private|public)$/);d?(g.name=d[1],g.type=d[2],f.recipe=new tiddlyweb.Recipe(c,"/"),a(g)):a(null,{name:"NoSpaceMatchError",message:b.recipe+" is not a valid space"})},error:function(b,c,d){a(null,d,b)}});return f},f.bind=function(){h.bind.apply(f,arguments);return f},f.unbind=function(){h.unbind.apply(f,arguments);return f},f.trigger=function(){h.trigger.apply(f,arguments);return f},f.refresh=function(a){var b=function(b){var c=b.tiddlers();c.get(function(c){$.each(c,function(a,b){l(b)}),k(b,c),a&&a.apply(f,[c])},function(b,c,d){a(null,{name:"RetrieveTiddlersError",message:"Error getting tiddlers: "+d},b)})};f.recipe?b(f.recipe):f.getSpace(function(){f.recipe&&b(f.recipe)});return f},f.get=function(a,b,c,d){var e=f.pending[a]||f.pending[a.title]||null,g=function(){var b=!d&&e?e:a;if(b instanceof tiddlyweb.Tiddler)return b;f.each(function(a,c){if(c===b){b=a;return!1}});return b}();if(!b)return $.extend(!0,new tiddlyweb.Tiddler,g);!d&&e?b.call(f,$.extend(!0,new tiddlyweb.Tiddler,g)):g?g.get(function(a){l(a),b.call(f,$.extend(!0,new tiddlyweb.Tiddler,a))},function(a,c,d){b.call(f,null,{name:"RetrieveTiddlersError",message:"Error getting tiddler: "+d},a)},c?"render=1":""):b.call(null,{name:"NotFoundError",message:"Tiddler not found"});return f},f.each=function(a,b){var c=typeof a=="function"?a:b,d=a==="bag"?!1:!0,e=function(a,b){var c=!0,d;for(d in a)if(a.hasOwnProperty(d)&&b(a[d],d)===!1){c=!1;break}return c};if(d&&!e(f.pending,c))return f;e(j,function(a,b){if(d){if(!e(j[b].tiddlers,c))return!1}else if(c(a.thing,b)===!1)return!1});return f},f.add=function(a){var b=function(a){var b;c.set(a),b=$.extend(!0,new tiddlyweb.Tiddler,a),f.pending[b.title]=i(b,!0),f.trigger("tiddler",b.title,b)};a.bag?b(a):f.getSpace(function(c){var d=c.name+"_public";a.bag=j[d]&&j[d].thing||new tiddlyweb.Bag(d,"/"),b(a)});return f},f.save=function(a,b){var d=!0,e=a instanceof tiddlyweb.Tiddler,g=!e&&a?a:b,h=function(a,b){delete f.pending[a.title],a.put(function(d){c.remove(a),d=i(d),l(d),b(d)},function(c,d,e){f.pending[a.title]||(f.pending[a.title]=i(a,!0)),b(null,{name:"SaveError",message:"Error saving "+a.title+": "+e},c)})};if(e){h(a,g);return f}$.each(f.pending,function(a,b){d&&(d=!1),h(b,g)}),d&&g(null,{name:"EmptyError",message:"Nothing to save"});return f},f.remove=function(a,b){var d={pending:!0,server:!1,tiddler:a,callback:b||function(){}};typeof a=="string"?d.tiddler=f.get(a):a instanceof tiddlyweb.Tiddler||$.extend(d,a);if(!d.tiddler)return f;d.pending&&(delete f.pending[d.tiddler.title],c.remove(d.tiddler)),d.server?d.tiddler["delete"](function(a){j[a.bag.name]&&delete j[a.bag.name].tiddlers[a.title],f.trigger("tiddler",a.title,[a,"deleted"]),d.callback(a)},function(a,b,c){d.callback(d.pending?d.tiddler:null,{name:"DeleteError",message:"Error deleting "+d.tiddler.title+": "+c},a)}):(f.trigger("tiddler",d.tiddler.title,[d.tiddler,"deleted"]),d.callback(d.tiddler));return f},f.retrieveCached=function(){$.each(c.list(),function(a,b){f.add(b)});return f},e&&f.retrieveCached(),d&&f.refresh(d);return f}}),function(a){require(["store"],function(b){a.Store=b})}(window.tiddlyweb),define("main.js",function(){})