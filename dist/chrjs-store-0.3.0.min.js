/* Chrjs-Store
 * A modular store for TiddlySpace
 *
 * See https://github.com/bengillies/chrjs.store for more
 *
 * Dependencies: chrjs library, jQuery, TiddlySpace
 *
 * Version: 0.3.0
 *
 * created by Ben Gillies
 * Chrjs-Store is distributed under a BSD License
 *//* Taken and modified from ACE IDE to provide a lightweight RequireJS that
 * loads dependencies immediately, instead of inside a setTimeout (as RequireJS
 * does). See:
 * (https://github.com/mozilla/ace/blob/master/build_support/mini_require.js)
 * for the original version.
 *
 * ***** BEGIN LICENSE BLOCK *****
 * Version: MPL 1.1/GPL 2.0/LGPL 2.1
 *
 * The contents of this file are subject to the Mozilla Public License Version
 * 1.1 (the "License"); you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 * http://www.mozilla.org/MPL/
 *
 * Software distributed under the License is distributed on an "AS IS" basis,
 * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
 * for the specific language governing rights and limitations under the
 * License.
 *
 * The Original Code is Ajax.org Code Editor (ACE).
 *
 * The Initial Developer of the Original Code is
 * Ajax.org B.V.
 * Portions created by the Initial Developer are Copyright (C) 2010
 * the Initial Developer. All Rights Reserved.
 *
 * Contributor(s):
 *      Fabian Jakobs <fabian AT ajax DOT org>
 *
 * Alternatively, the contents of this file may be used under the terms of
 * either the GNU General Public License Version 2 or later (the "GPL"), or
 * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
 * in which case the provisions of the GPL or the LGPL are applicable instead
 * of those above. If you wish to allow use of your version of this file only
 * under the terms of either the GPL or the LGPL, and not to allow others to
 * use your version of this file under the terms of the MPL, indicate your
 * decision by deleting the provisions above and replace them with the notice
 * and other provisions required by the GPL or the LGPL. If you do not delete
 * the provisions above, a recipient may use your version of this file under
 * the terms of any one of the MPL, the GPL or the LGPL.
 *
 * ***** END LICENSE BLOCK ***** *//**
 * Define a module along with a payload
 * @param module a name for the payload
 * @param payload a function to call with (require, exports, module) params
 */var obj=function(){var a=function(b,c,d){typeof b!="string"?(console.error("dropping module because define wasn't a string."),console.trace()):(arguments.length==2&&(d=c),a.modules||(a.modules={require:{payload:window.require,deps:[]},define:{payload:window.define,deps:[]},exports:{payload:{},deps:[]},module:{payload:{},deps:[]}}),a.modules[b]={payload:d,deps:c})},b=function(a,b){if(Object.prototype.toString.call(a)==="[object Array]"){var d=[];for(var e=0,f=a.length;e<f;++e){var g=c(a[e]);d.push(g)}b&&b.apply(null,d)}else if(typeof a=="string"){var h=c(a);b&&b();return h}},c=function(d){var e=a.modules[d],f=e?e.payload:null,g=e?e.deps:null;if(f==null){console.error("Missing module: "+d);return null}if(typeof f=="function"){var h={},i,j=[],k;for(i=0;i<g.length;i++)j.push(c(g[i]));j.length===0&&(j=[b,h,{id:d,uri:""}]),k=f.apply(this,j);return k||h}return f};return{require:b,define:a}}(),require=obj.require,define=obj.define;define("filter-syntax",["require","exports","module"],function(){var a={title:{match:/^\[\[[^\]\]]+\]\]/,action:function(a){return a.slice(2).split(/\]\](.*)/)},tiddlerTest:function(a){return function(b){return b.title===a?!0:!1}}},notTitle:{match:/^!\[\[[^\]\]]+\]\]/,action:function(a){return a.slice(3).split(/\]\](.*)/)},tiddlerTest:function(a){return function(b){return b.title!==a?!0:!1}}},tag:{match:/^#.+/,action:function(a){return a.slice(1).split(/((?:\W|,).*)/)},tiddlerTest:function(a){return function(b){return~b.tags.indexOf(a)?!0:!1}}},notTag:{match:/^!#.+/,action:function(a){return a.slice(2).split(/((?:\W|,).*)/)},tiddlerTest:function(a){return function(b){return~b.tags.indexOf(a)?!1:!0}}},field:{match:/^\[[^!=\]]+=[^\]]+\]/,action:function(a){var b=a.indexOf("="),c=a.indexOf("]"),d,e=a.slice(1,b),f=a.slice(b+1,c),g=a.slice(c+1);d={field:e,value:f};return[d,g]},tiddlerTest:function(a){return function(b){return b[a.field]||(b.fields&&b.fields[a.field])===a.value?!0:!1}}},notField:{match:/^\[[^!=\]]+!=[^\]]+\]/,action:function(a){var b=a.indexOf("!="),c=a.indexOf("]"),d,e=a.slice(1,b),f=a.slice(b+2,c),g=a.slice(c+1);d={field:e,value:f};return[d,g]},tiddlerTest:function(a){return function(b){return b[a.fields]||(b.fields&&b.fields[a.field])!==a.value?!0:!1}}},space:{match:/^@.+/,action:function(a){return a.slice(1).split(/((?:\W|,).*)/)},tiddlerTest:function(a){return function(b){return b.bag.name.split(/_(public|private)$/)[0]===a?!0:!1}}},notSpace:{match:/^!@.+/,action:function(a){return a.slice(2).split(/((?:\W|,).*)/)},tiddlerTest:function(a){return function(b){return b.bag.name.split(/_(public|private)$/)[0]!==a?!0:!1}}},modifier:{match:/^\+.+/,action:function(a){return a.slice(1).split(/((?:\W|,).*)/)},tiddlerTest:function(a){return function(b){return b.modifier===a?!0:!1}}},notModifier:{match:/^!\+.+/,action:function(a){return a.slice(2).split(/((?:\W|,).*)/)},tiddlerTest:function(a){return function(b){return b.modifier!==a?!0:!1}}},text:{match:/^"[^"]+"/,action:function(a){return a.slice(1).split(/"(.*)/)},tiddlerTest:function(a){return function(b){return~b.text.indexOf(a)?!0:!1}}},notText:{match:/^!"[^"]+"/,action:function(a){return a.slice(2).split(/"(.*)/)},tiddlerTest:function(a){return function(b){return~b.text.indexOf(a)?!1:!0}}},or:{match:/^,/,action:function(a){return["or",a.slice(1)]}}},b=function(b){var c=$.trim(b),d=null,e;$.each(a,function(a,b){if(b.match.test(c)){d=a;return!1}});if(d){e=a[d].action(c);return[d,e[0],e[1]]}return!1},c=function(a){var c={type:"or",value:[]},d,e={type:"and",value:[]},f=b(a);while(f)d={type:f[0],value:f[1]},d.or?(c.value.push(e),e={type:"and",value:[]}):e.value.push(d),f=b(f[2]);e.value.length>0&&c.value.push(e);return c},d=function(a){return function(b){var c=!0;$.each(a,function(a,d){if(!d(b)){c=!1;return!1}});return c}},e=function(a){return function(b){var c=!1;$.each(a,function(a,d){if(d(b)){c=!0;return!1}});return c}},f=function(b){var c=function(b){var f,g=[];switch(b.type){case"and":$.each(b.value,function(a,b){g.push(c(b))}),f=d(g);break;case"or":$.each(b.value,function(a,b){g.push(c(b))}),f=e(g);break;case"function":f=function(a){return b.value(a)?!0:!1};break;default:f=a[b.type].tiddlerTest(b.value)}return f},f,g;g=c(b);var f=function(a){var b=$.extend(!0,new tiddlyweb.Tiddler,a);return g(b)};return f};return{parse:c,match:b,createTester:f}}),define("filter",["filter-syntax"],function(a){var b,c;b=function(a,c){var d=[];d.store=a,d.ast={type:"and",value:[]},c&&$.each(c,function(a,b){d.push(b)}),$.extend(d,b.fn);return d},c=function(a,b){return a&&a.indexOf(b)!==-1?!0:!1},b.fn={find:function(b){var c=a.parse(b),d;d=a.createTester(c);return this.map(function(a){return d(a)?a:null})},tag:function(a){return this.map(function(b){return c(b.tags,a)?b:null})},text:function(a){return this.map(function(b){return c(b.text,a)?b:null})},title:function(a){return this.map(function(b){return c(b.title,a)?b:null})},attr:function(a,b){var d=b?!1:!0,e=function(b){return b[a]||b.fields&&b.fields[a]};return this.map(function(a){return d?e(a)?a:null:c(e(a),b)?a:null})},not:function(a,b){var d=b?!1:!0,e=function(b){return b[a]||b.fields&&b.fields[a]};return this.map(function(a){return d?e(a)?null:a:c(e(a),b)?null:a})},bag:function(a){return this.map(function(b){var c=b.bag&&b.bag.name;return c===a?b:null})},space:function(a){var b=/(_public|_private|_archive)$/,c=undefined,d;a===!0||a===undefined?c=!0:a===!1&&(c=!1),c!==undefined&&(d=this.store.recipe&&this.store.recipe.name.replace(b,""));return this.map(function(e){var f=(e.bag&&e.bag.name).replace(b,"");d||(d=this.store.recipe&&this.store.recipe.name.replace(b,"")||f);return c?f===d?e:null:c===!1?f===d?null:e:f===a?e:null})},recipe:function(a){var b=a===undefined?!0:!1,c;b&&(c=this.store.recipe.name);return this.map(function(d){b||(c=d.recipe&&d.recipe.name);return c===a?d:null})},dirty:function(a){return a?this.map(function(b){return b.lastSync?+b.lastSync<+a?b:null:b}):this.map(function(a){return a.lastSync?null:a})},each:function(a){var b=this;$.each(b,function(c,d){a.apply(b,[d,c])});return b},map:function(a){var c=this,d=b(c.store);d.ast=c.ast,d.ast.value.push({type:"function",value:function(b){var c=a.apply(d,[b,i]);return c?!0:!1}}),$.each(c,function(b,e){var f=a.apply(c,[e,b]);f&&d.push(f)});return d},reduce:function(a,b){var c=a,d=this;$.each(d,function(a,e){c=b.apply(d,[e,c])});return c},unique:function(){var a={},c=this,d=b(c.store);$.each(this,function(b,c){var d,e,f;a[c.title]?c.lastSync||(a[c.title]=c):a[c.title]=c}),$.each(a,function(a,b){d.push(b)});return d},bind:function(b){var c=this,d=function(a){b.apply(c,[a])};c.store.bind("filter",a.createTester(c.ast),d);return c},save:function(a){var b=this;$.each(b,function(c,d){b.store.save(d,a)});return b},add:function(a){var b=this;a instanceof tiddlyweb.Tiddler?(b.push(a),b.store.add(a)):$.each(a,function(c,d){b.push(d),b.store.add(a)});return b}};return b}),define("event",["require","exports","module"],function(){return function(){var a={recipe:{all:[]},bag:{all:[]},tiddler:{all:[]},filter:[]},b={bind:function(b,c,d){b==="filter"?a.filter.push({test:c,callback:d}):a[b]&&(c?(a[b][c+b]||(a[b][c+b]=[]),a[b][c+b].push(d)):a[b].all.push(d))},unbind:function(b,c,d){var e=function(a){if(d){$.each(a,function(b,c){d===c&&a.splice(b,1)});return a}return[]};b==="filter"?$.each(a.filter,function(b,c){c.test===d&&a.filter.splice(b,1)}):a[b]&&c?a[b][c+b]=e(a[b][c+b]):a[b].all=e(a[b].all)},trigger:function(b,c,d){var e=$.isArray(d)?d:[d],f,g=this;a[b]&&($.each(a[b].all,function(a,b){b.apply(g,e)}),c&&a[b][c+b]&&$.each(a[b][c+b],function(a,b){b.apply(g,e)})),b==="tiddler"&&(f=d instanceof tiddlyweb.Tiddler?d:d[0],$.each(a.filter,function(a,b){b.test(f)&&b.callback.apply(g,e)}))}};return b}}),define("cache",["require","exports","module"],function(){var a=function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return!1}}(),b=function(a){return encodeURIComponent(a.bag.name)+"/"+encodeURIComponent(a.title)};return{isCaching:a,set:function(c){var d=b(c);a&&window.localStorage.setItem(d,c.toJSON())},get:function(c){var d=b(c),e,f;if(a){e=window.localStorage[d],f=$.parseJSON(e),e=new tiddlyweb.Tiddler(c.title),e.bag=c.bag,$.extend(e,f);return e}return null},remove:function(c){var d=b(c);a&&window.localStorage.removeItem(d)},list:function(){var b=[];a&&$.each(window.localStorage,function(a){try{var c=window.localStorage.key(a),d,e,f,g,h;d=c.split("/");if(d.length!==2)throw"BadKey";e=decodeURIComponent(d[0]),f=decodeURIComponent(d[1]),g=$.parseJSON(window.localStorage[c]),h=new tiddlyweb.Tiddler(f),h.bag=new tiddlyweb.Bag(e,"/"),$.extend(h,g),b.push(h)}catch(i){}});return b},clear:function(){a&&window.localStorage.clear()}}}),define("store",["filter","event","cache"],function(a,b,c){return function(d,e){e===undefined&&(e=!0);var f,g={name:"",type:"private"},h=b(),i=function(a,b){var c;a instanceof tiddlyweb.Bag?c={thing:a,tiddlers:{}}:(a.lastSync=b?null:new Date,c=a);return c},j={},k=function(b,c){var d,e=a(f,c),g=[];e=e.map(function(a){return a.title}),b instanceof tiddlyweb.Bag?(d=j[b.name].tiddlers,$.each(d,function(a,c){e.indexOf(c.title)===-1&&g.push([b.name,a])})):b instanceof tiddlyweb.Recipe&&f.each(function(a,c){a.recipe&&a.recipe.name===b.name&&e.indexOf(a.title)===-1&&g.push([a.bag.name,c])}),$.each(g,function(a,b){var c=b[1],d=b[0],e=j[d].tiddlers[c];delete j[d].tiddlers[c],f.trigger("tiddler",c,[e,"deleted"])})},l;l=function(a){if(a instanceof tiddlyweb.Bag){j[a.name]?j[a.name].thing=a:j[a.name]=i(a),f.trigger("bag",a.name,a);return!0}var b=a.bag.name,c=j[b]?j[b]:!l(new tiddlyweb.Bag(b,"/")),d=!c||!c.tiddlers[a.title]?null:c.tiddlers[a.title].revision;j[b].tiddlers[a.title]=i(a),a.revision!==d&&f.trigger("tiddler",a.title,a);return!0},f=function(b,c){var d=a(f);f.each(function(a,b){d.push(a)}),d[b]?d=d[b](c):b&&(d=d.attr(b,c)),d=d.map(function(a){return $.extend(!0,new tiddlyweb.Tiddler,a)});return d},f.recipe=null,f.pending={},f.fn=a.fn,f.getSpace=function(a){g.name!==""?a(g):$.ajax({url:"/?limit=1",dataType:"json",success:function(b){var c=(b instanceof Array?b[0].recipe:b.recipe)||"No Recipe Found",d=c.match(/^(.*)_(private|public)$/);d?(g.name=d[1],g.type=d[2],f.recipe=new tiddlyweb.Recipe(c,"/"),a(g)):a(null,{name:"NoSpaceMatchError",message:b.recipe+" is not a valid space"})},error:function(b,c,d){a(null,d,b)}});return f},f.bind=function(){h.bind.apply(f,arguments);return f},f.unbind=function(){h.unbind.apply(f,arguments);return f},f.trigger=function(){h.trigger.apply(f,arguments);return f},f.refresh=function(a){var b=function(b){var c=b.tiddlers();c.get(function(c){$.each(c,function(a,b){l(b)}),k(b,c),a&&a.apply(f,[c])},function(b,c,d){a(null,{name:"RetrieveTiddlersError",message:"Error getting tiddlers: "+d},b)})};f.recipe?b(f.recipe):f.getSpace(function(){f.recipe&&b(f.recipe)});return f},f.get=function(a,b,c,d){var e=f.pending[a]||f.pending[a.title]||null,g=function(){var b=!d&&e?e:a;if(b instanceof tiddlyweb.Tiddler)return b;f.each(function(a,c){if(c===b){b=a;return!1}});return b}();if(!b)return $.extend(!0,new tiddlyweb.Tiddler,g);!d&&e?b.call(f,$.extend(!0,new tiddlyweb.Tiddler,g)):g?g.get(function(a){l(a),b.call(f,$.extend(!0,new tiddlyweb.Tiddler,a))},function(a,c,d){b.call(f,null,{name:"RetrieveTiddlersError",message:"Error getting tiddler: "+d},a)},c?"render=1":""):b.call(null,{name:"NotFoundError",message:"Tiddler not found"});return f},f.each=function(a,b){var c=typeof a=="function"?a:b,d=a==="bag"?!1:!0,e=function(a,b){var c=!0,d;for(d in a)if(a.hasOwnProperty(d)&&b(a[d],d)===!1){c=!1;break}return c};if(d&&!e(f.pending,c))return f;e(j,function(a,b){if(d){if(!e(j[b].tiddlers,c))return!1}else if(c(a.thing,b)===!1)return!1});return f},f.add=function(a){var b=function(a){var b;c.set(a),b=$.extend(!0,new tiddlyweb.Tiddler,a),f.pending[b.title]=i(b,!0),f.trigger("tiddler",b.title,b)};a.bag?b(a):f.getSpace(function(c){var d=c.name+"_public";a.bag=j[d]&&j[d].thing||new tiddlyweb.Bag(d,"/"),b(a)});return f},f.save=function(a,b){var d=!0,e=a instanceof tiddlyweb.Tiddler,g=!e&&a?a:b,h=function(a,b){delete f.pending[a.title],a.put(function(d){c.remove(a),d=i(d),l(d),b(d)},function(c,d,e){f.pending[a.title]||(f.pending[a.title]=i(a,!0)),b(null,{name:"SaveError",message:"Error saving "+a.title+": "+e},c)})};if(e){h(a,g);return f}$.each(f.pending,function(a,b){d&&(d=!1),h(b,g)}),d&&g(null,{name:"EmptyError",message:"Nothing to save"});return f},f.remove=function(a,b){var d={pending:!0,server:!1,tiddler:a,callback:b||function(){}};typeof a=="string"?d.tiddler=f.get(a):a instanceof tiddlyweb.Tiddler||$.extend(d,a);if(!d.tiddler)return f;d.pending&&(delete f.pending[d.tiddler.title],c.remove(d.tiddler)),d.server?d.tiddler["delete"](function(a){j[a.bag.name]&&delete j[a.bag.name].tiddlers[a.title],f.trigger("tiddler",a.title,[a,"deleted"]),d.callback(a)},function(a,b,c){d.callback(d.pending?d.tiddler:null,{name:"DeleteError",message:"Error deleting "+d.tiddler.title+": "+c},a)}):(f.trigger("tiddler",d.tiddler.title,[d.tiddler,"deleted"]),d.callback(d.tiddler));return f},f.retrieveCached=function(){$.each(c.list(),function(a,b){f.add(b)});return f},e&&f.retrieveCached(),d&&f.refresh(d);return f}}),function(a){require(["store"],function(b){a.Store=b})}(window.tiddlyweb)